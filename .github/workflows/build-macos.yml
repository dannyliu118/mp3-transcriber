name: Build macOS App

on:
  # 當推送到 main 或 master 分支，或推送 tag 時執行
  push:
    branches: 
      - main
      - master
    tags:
      - 'v*'
  
  # 允許手動觸發
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    # 步驟 1: 檢出程式碼
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 步驟 2: 設定 Python 環境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # 步驟 3: 安裝依賴
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 步驟 4: 使用 PyInstaller 打包
    - name: Build with PyInstaller
      run: |
        pyinstaller transcriber.spec
    
    # 步驟 5: 壓縮應用程式
    - name: Create ZIP archive
      run: |
        cd dist
        zip -r 中文轉錄工具-macOS.zip 中文轉錄工具.app
    
    # 步驟 6: 上傳 Artifact（可下載）
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macOS-App
        path: dist/中文轉錄工具-macOS.zip
    
    # 步驟 7: 如果是 tag，自動發布 Release
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/中文轉錄工具-macOS.zip
        body: |
          ## 下載說明
          
          1. 下載 `中文轉錄工具-macOS.zip`
          2. 解壓縮後雙擊 `中文轉錄工具.app`
          3. 如果出現